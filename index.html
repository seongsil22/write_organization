<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI 글 정리 프로그램 by Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            margin: 0 auto;
            max-width: 800px;
            padding: 20px;
            background-color: #f9f9f9;
            color: #333;
        }
        h1, h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            color: #1a73e8;
        }
        textarea {
            width: 100%;
            height: 250px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
            resize: vertical;
        }
        .output-box {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .loader {
            text-align: center;
            font-style: italic;
            color: #888;
        }
        .error-message {
            color: red;
            font-weight: bold;
        }
        .header-with-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #copyButton {
            padding: 6px 12px;
            font-size: 14px;
            background-color: #e0e0e0;
            color: #333;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #copyButton:hover {
            background-color: #ccc;
        }
    </style>
</head>
<body>

    <h1 class="text-3xl font-bold text-center mb-2">AI 글 정리 프로그램 ✨</h1>
    <p class="text-center text-gray-600 mb-8">아래 상자에 정리할 글을 붙여넣고 '정리하기' 버튼을 누르세요.</p>

    <!-- API 키 입력 섹션 -->
    <div class="mb-6">
        <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">Gemini API 키</label>
        <input type="password" id="apiKeyInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="API 키를 입력하세요">
        <p class="text-xs text-gray-500 mt-1">API 키는 브라우저에만 저장되며 외부로 전송되지 않습니다. <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 hover:underline">API 키 발급 방법</a></p>
    </div>

    <textarea id="inputText" placeholder="여기에 정리하고 싶은 글 전문을 붙여넣으세요..." class="mb-4"></textarea>
    
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <!-- Action Buttons -->
        <div class="flex items-center gap-2">
            <button id="processButton" onclick="processText()" class="flex items-center justify-center px-5 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                <svg class="w-5 h-5 mr-2 -ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                정리하기
            </button>
            <button id="clearButton" onclick="clearAll()" class="flex items-center justify-center px-5 py-3 text-sm font-medium text-gray-800 bg-gray-200 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-colors">
                 <svg class="w-5 h-5 mr-2 -ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                전체 삭제
            </button>
        </div>
        <!-- Analysis Option -->
        <div class="flex items-center pt-2 sm:pt-0">
            <input type="checkbox" id="includeAnalysis" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <label for="includeAnalysis" class="ml-2 text-sm text-gray-700">내용 검증 및 분석 포함 (시간이 더 걸릴 수 있습니다)</label>
        </div>
    </div>

    <div class="header-with-button mt-8">
        <h2>✔️ 정리된 글 (맞춤법 수정)</h2>
        <button id="copyButton" onclick="copyCleanedText()">복사하기</button>
    </div>
    <div id="cleanedOutput" class="output-box">정리된 글이 여기에 표시됩니다.</div>

    <div id="analysisContainer" style="display: none;">
        <h2>🔬 내용 검증 및 분석</h2>
        <div id="analysisOutput" class="output-box">내용 분석 결과가 여기에 표시됩니다.</div>
    </div>

    <script>
        const apiKeyInput = document.getElementById('apiKeyInput');

        // 페이지 로드 시 localStorage에서 API 키 불러오기
        apiKeyInput.value = localStorage.getItem('geminiApiKey_textProcessor') || '';

        // API 키가 변경될 때 localStorage에 저장하기
        apiKeyInput.addEventListener('input', () => {
            localStorage.setItem('geminiApiKey_textProcessor', apiKeyInput.value);
        });
        
        function clearAll() {
            document.getElementById('inputText').value = '';
            document.getElementById('cleanedOutput').innerHTML = '정리된 글이 여기에 표시됩니다.';
            
            const analysisContainer = document.getElementById('analysisContainer');
            analysisContainer.style.display = 'none';
            document.getElementById('analysisOutput').innerHTML = '내용 분석 결과가 여기에 표시됩니다.';
            document.getElementById('copyButton').textContent = '복사하기';
        }

        function copyCleanedText() {
            const textToCopy = document.getElementById('cleanedOutput').innerText;
            const copyButton = document.getElementById('copyButton');
            
            if (!textToCopy || textToCopy.includes('여기에 표시됩니다')) {
                alert('복사할 내용이 없습니다.');
                return;
            }

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            copyButton.textContent = '복사 완료!';
            setTimeout(() => {
                copyButton.textContent = '복사하기';
            }, 2000);
        }

        async function processText() {
            const API_KEY = apiKeyInput.value.trim();

            if (!API_KEY) {
                alert("Gemini API 키를 입력 필드에 입력해주세요.");
                return;
            }

            const userText = document.getElementById('inputText').value;
            if (!userText.trim()) {
                alert("정리할 글을 입력해주세요.");
                return;
            }

            const processButton = document.getElementById('processButton');
            const cleanedDiv = document.getElementById('cleanedOutput');
            const analysisContainer = document.getElementById('analysisContainer');
            const analysisDiv = document.getElementById('analysisOutput');
            const includeAnalysisCheckbox = document.getElementById('includeAnalysis');

            processButton.disabled = true;
            processButton.textContent = "처리 중...";
            cleanedDiv.innerHTML = '<div class="loader">AI가 글을 정리하고 있습니다...</div>';
            
            if(includeAnalysisCheckbox.checked) {
                analysisContainer.style.display = 'block';
                analysisDiv.innerHTML = '<div class="loader">AI가 내용을 분석하고 있습니다...</div>';
            } else {
                analysisContainer.style.display = 'none';
            }

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            
            let systemPrompt = `
                당신은 글을 정리하고 분석하는 AI 어시스턴트입니다. 다음 요청사항을 정확히 수행해주세요.

                요청사항:
                1. 주어진 원본 글을 내용의 주제별로 문단을 나누어 가독성 좋게 재구성해주세요. (같은 주제는 붙이고, 다른 주제는 한 줄 띄기)
                2. 명백한 맞춤법 오류나 오타는 수정해주세요.
                3. 하지만 사용자가 의도적으로 쓴 것으로 보이는 비속어(예: '자빠졌는데', '개작살', '깝치다' 등)는 수정하지 말고 그대로 유지해주세요.
            `;

            let jsonStructure = `
                5. 최종 결과물은 반드시 아래와 같은 JSON 형식으로 반환해주세요.

                {
                  "cleanedText": "여기에 1, 2, 3번 요청에 따라 정리된 글 전문을 넣으세요."
                }
            `;

            if (includeAnalysisCheckbox.checked) {
                systemPrompt += `
                4. 수정된 글과는 별개로, 원본 글의 내용에 대한 '종합 검증 및 분석'을 제공해주세요. 분석에는 전반적인 요약, 주요 주장, 표현 방식, 검증 포인트(사실과 주장의 구분), 최종 결론이 포함되어야 합니다.
                `;
                jsonStructure = `
                5. 최종 결과물은 반드시 아래와 같은 JSON 형식으로 반환해주세요.

                {
                  "cleanedText": "여기에 1, 2, 3번 요청에 따라 정리된 글 전문을 넣으세요.",
                  "analysis": "여기에 4번 요청에 따라 마크다운 형식으로 작성된 분석 내용을 넣으세요."
                }
                `;
            }

            const finalPrompt = systemPrompt + jsonStructure;
            const userQuery = `[원본 글]\n---\n${userText}\n---`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: finalPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API 요청 실패: ${response.status} ${response.statusText} - ${errorBody.error?.message || '알 수 없는 오류'}`);
                }

                const data = await response.json();
                const candidate = data.candidates?.[0];
                const rawJsonText = candidate?.content?.parts?.[0]?.text;

                if (rawJsonText) {
                    const parsedData = JSON.parse(rawJsonText);
                    
                    if (parsedData.cleanedText) {
                        cleanedDiv.textContent = parsedData.cleanedText;
                    } else {
                        throw new Error('API 응답 JSON에 cleanedText 키가 없습니다.');
                    }

                    if (includeAnalysisCheckbox.checked) {
                        if (parsedData.analysis) {
                            let analysisHtml = parsedData.analysis;
                            analysisHtml = analysisHtml.replace(/## (.*)/g, '<h3>$1</h3>');
                            analysisHtml = analysisHtml.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                            analysisHtml = analysisHtml.replace(/-\s(.*)/g, '<li>$1</li>')
                                                 .replace(/(<\/li>)(?!<ul>)/g, '</li></ul>')
                                                 .replace(/(<li>)/g, '<ul>$1');
                            analysisDiv.innerHTML = analysisHtml;
                        } else {
                             analysisDiv.innerHTML = '<p>분석 결과를 가져오는 데 실패했습니다.</p>';
                        }
                    }
                
                } else {
                    throw new Error('API 응답에서 유효한 텍스트를 찾을 수 없습니다.');
                }
            } catch (error) {
                cleanedDiv.innerHTML = `<p class="error-message">오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>`;
                if (includeAnalysisCheckbox.checked) {
                    analysisDiv.innerHTML = `<p class="error-message">오류 상세 정보:</p><p>${error.message}</p>`;
                }
                console.error('Error:', error);
            } finally {
                processButton.disabled = false;
                processButton.textContent = "정리하기";
            }
        }
    </script>

</body>
</html>

